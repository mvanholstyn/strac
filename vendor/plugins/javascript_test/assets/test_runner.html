<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>JavaScript unit test file</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  
  <script src="../../../../public/javascripts/prototype.js" type="text/javascript"></script>  
  <script src="../../../../public/javascripts/effects.js" type="text/javascript"></script>  
  <script src="../../../../public/javascripts/objectevent.js" type="text/javascript"></script>  
  
  <script src="unittest.js" type="text/javascript"></script>
  <script src="JaySmock.js" type="text/javascript"></script</script></script></script></script></script>
  
  <link rel="stylesheet" href="unittest.css" type="text/css" />
</head>
<body>

<div id="content">

  <div id="header">
    <h1>JavaScript unit test file</h1>
  </div>

  <div id="logs"></div>

  <!-- Log output -->
  
  <div id="testlog"> </div>
  <script type="text/javascript">
    function randomSuffix() {
      var str = Math.random().toString();
      return '?randomness=' + str.substring(2, str.length);
    }

    function includeScript(script) {
      var s = document.createElement('script');
      s.setAttribute('src', '../../../../test/javascript/' + script + randomSuffix());
      $$('head')[0].appendChild(s);
    }

    var describes = [];
    var nested_describe_depth = 0;
    var setups = [];
    var original_setup;
    function describe(name, spec) {
      var added = 0;
      if(nested_describe_depth > 0){
        if(!setups.include(this.setup)){
           setups.push(this.setup);
           added++;
         }
        if(spec['setup'] ){
          setups.push(spec['setup']);
          added++;
        }
      }

      if(typeof spec == "function"){
        if(setups.size() == 0) original_setup = this.setup;
        nested_describe_depth += 1;
        spec();
        while(added-- >= 0){
          setups.pop();
        }
      } else {
        var logName = name.gsub(/\W/,'_') + 'Log';

        var label = document.createElement('h1');
        label.innerHTML = name
        $('logs').appendChild(label);

        var log = document.createElement('div');
        log.setAttribute('id', logName);
        $('logs').appendChild(log);
        
        if(nested_describe_depth > 0){
          my_setups = setups.clone();
          spec.setup = function(){
            my_setups.each(function(s){
              if(s) s();
            });
          }
        }
        describes.push({
          logName: logName,
          spec: spec,
          name: name
        });
      }
    }

    var requiredFiles = [];
    function require() {
      $A(arguments).each(function(requirement) {
        if(requiredFiles.indexOf(requirement) < 0) {
          requiredFiles.push(requirement);
          includeScript(requirement);
        }
      })
    }


    var toRun = window.location.search.parseQuery()['tests'].split(',');
    for(var i = 0; i < toRun.length; i++) {
      includeScript(toRun[i] + "_test.js");
    }

  </script>
  <script>
  Event.observe(window, 'load', function() {
    var resultPoster = document.createElement('img');
    resultPoster.setAttribute('src', Test.Unit.Runner.prototype.parseResultsURLQueryParameter() + "?tests=" + describes.map(function(a){return escape(a.name)}).join(',') + "&test_count=" + describes.length);
    resultPoster.setAttribute('style', 'display:none');
    $('logs').appendChild(resultPoster);

    setTimeout(function() {
      for(var i = 0; i < describes.length; i++) {
        new Test.Unit.Runner(describes[i].spec, {testLog: describes[i].logName});
      }
    }, 100);
  });
  </script>
</div>


</body>
</html>
