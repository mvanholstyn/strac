<div class="section">
  <h2>Current Iteration</h2>

  <% if @iteration.new_record? -%>
    Oops! No current iteration exists. Please take a moment to create one below.
  	<%= render "iterations/new" %>
  <% else -%>
  	<table width="100%">
  	  <tr>
  	    <td>
  			<%= render :partial => 'iterations/header', :locals => { :iteration => @iteration } %>
  	    </td>
  	    <td align="right"><%= link_to_remote "create story", :url => new_story_path( :project_id => @project, :bucket_id => @iteration ), :method => :get %></td>
  	  </tr>
  	</table>
  	<div id="iteration_<%= @iteration.id %>_story_new"></div>
  	<div id="iteration_<%= @iteration.id %>" class="story_list">
  	  <%= render :partial  => 'stories/list', :locals => { :stories => @iteration.stories.find( :all, :order => :position ) } %>
  	</div>
    <% javascript_tag do %>
      Strac.Iteration.drawCurrentIterationVelocityMarker();
    <% end %>
  <% end -%>

  <br />

  <table width="100%">
    <tr>
      <td>
      	<b>Backlog</b>
      </td>
      <td align="right"><%= link_to_remote "create story", :url => new_story_path( @project ), :method => :get %></td>
    </tr>
  </table>
  <div id="iteration_nil_story_new"></div>
  <div id="iteration_nil" class="story_list">
  	<%= render :partial  => 'stories/list', :locals => { :stories => @stories } %>
  </div>

  <% iteration_list_ids = [ "iteration_nil", "iteration_#{@iteration.id}" ] -%>
  <% for iteration in iteration_list_ids -%>
    <%= sortable_element iteration,
                         :url => reorder_stories_path(@project), :method => :put,
                         :tag => 'div', :handle => 'draggable', :dropOnEmpty => true, 
                         :containment => iteration_list_ids,
                         :onChange =>  "Strac.Iteration.drawCurrentIterationVelocityMarker"
                          -%>
  <% end -%>

</div>